<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Workshop Agenda Builder</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    label, select, input, button {
      width: 100%; padding: 10px; margin-top: 10px;
    }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc; padding: 10px;
      text-align: left;
    }
    th {
      background: #ffa500;
      color: #000;
    }
    .day-row {
      background-color: #5b9bd5;
      color: white;
      font-weight: bold;
      text-align: center;
    }
    .break-row {
      background-color: #d9d9d9;
      font-style: italic;
      text-align: center;
    }
  </style>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
<h2>Workshop Agenda Builder</h2>

<!-- ðŸ†• Day header section -->
<label for="dayHeader">Add Day Section (optional)</label>
<select id="dayHeader">
  <option value="">-- Select Day (only if needed) --</option>
  <option>Day 1</option>
  <option>Day 2</option>
  <option>Day 3</option>
  <option>Day 4</option>
  <option>Day 5</option>
</select>
<button onclick="addDayHeader()">âž• Add Day Header</button>

<!-- ðŸ†• Break header section -->
<label for="breakType">Add Break (optional)</label>
<select id="breakType">
  <option value="">-- Select Break Type --</option>
  <option>Tea Break</option>
  <option>Lunch Break</option>
  <option>Coffee Break</option>
  <option>Snacks Break</option>
</select>
<button onclick="addBreak()">â˜• Add Break</button>

<hr>

<!-- Agenda builder form -->
<label for="topic">Topic</label>
<select id="topic"><option value="">Loading topics...</option></select>

<label for="subtopics">Sub-topic(s)</label>
<select id="subtopics" multiple size="6" disabled></select>

<label for="startTime">Start Time</label>
<input type="time" id="startTime">

<label for="duration">Duration (minutes)</label>
<select id="duration">
  <option value="30">30</option>
  <option value="45">45</option>
  <option value="60" selected>60</option>
</select>

<label for="mode">Facilitation Mode</label>
<select id="mode">
  <option value="">-- Select Mode --</option>
  <option>Form Responses</option>
  <option>Discussion</option>
  <option>Presentation</option>
  <option>Activity</option>
  <option>Discussion+Activity</option>
  <option>Presentation+Activity</option>
  <option>Presentation+Form Responses</option>
</select>

<label for="facilitator">Facilitator</label>
<input type="text" id="facilitator" placeholder="Facilitator Name" />

<button onclick="addToAgenda()">Add to Agenda</button>

<h3>Agenda</h3>
<table id="agendaTable">
  <thead>
    <tr>
      <th>Time</th>
      <th>Session</th>
      <th>Learning Objective</th>
      <th>Mode</th>
      <th>Facilitator</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button onclick="downloadExcel()">Download as Excel</button>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTA9WJB4yhBjiiE7nUo34v-VcN6wK-2HyMqXxU_WHTWs4xwtKc72fF4tmaKxCf9RrJ0W2s6vdJgbYFo/pub?gid=0&single=true&output=csv";
const topicSelect = document.getElementById("topic");
const subTopicSelect = document.getElementById("subtopics");
const agendaBody = document.querySelector("#agendaTable tbody");

// Load topics/subtopics
fetch(csvUrl)
  .then(res => res.text())
  .then(csv => {
    const rows = csv.trim().split("\n").map(row => row.split(","));
    const headers = rows[0];
    const clean = str => str.replace(/\uFEFF/g, '').trim().toLowerCase();
    const lowerHeaders = headers.map(clean);
    const topicIdx = lowerHeaders.findIndex(h => h === 'topic');
    const subIdx = lowerHeaders.findIndex(h => h === 'sub-topic');
    if (topicIdx === -1 || subIdx === -1) {
      alert("CSV must have 'Topic' and 'Sub-topic' headers.");
      return;
    }
    const topicMap = {};
    rows.slice(1).forEach(row => {
      const topic = row[topicIdx]?.trim();
      const sub = row[subIdx]?.trim();
      if (!topic || !sub) return;
      if (!topicMap[topic]) topicMap[topic] = [];
      if (!topicMap[topic].includes(sub)) topicMap[topic].push(sub);
    });
    topicSelect.innerHTML = '<option value="">-- Select Topic --</option>';
    Object.keys(topicMap).forEach(topic => topicSelect.add(new Option(topic, topic)));
    topicSelect.addEventListener("change", () => {
      subTopicSelect.innerHTML = "";
      const subs = topicMap[topicSelect.value] || [];
      subs.forEach(sub => subTopicSelect.add(new Option(sub, sub)));
      subTopicSelect.disabled = subs.length === 0;
    });
  })
  .catch(() => alert("Failed to fetch data from Google Sheet."));

function toDate(timeStr) {
  const [h, m] = timeStr.split(":").map(Number);
  const d = new Date();
  d.setHours(h, m, 0);
  return d;
}

function formatTime(d) {
  return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Add a day section
function addDayHeader() {
  const day = document.getElementById("dayHeader").value;
  if (!day) return alert("Please select a day to add.");
  const row = agendaBody.insertRow();
  const cell = row.insertCell();
  cell.colSpan = 5;
  cell.textContent = day.toUpperCase();
  row.classList.add("day-row");
  document.getElementById("dayHeader").value = "";
}

// ðŸ†• Add a break section when needed
function addBreak() {
  const breakType = document.getElementById("breakType").value;
  if (!breakType) return alert("Please select a break type.");
  const row = agendaBody.insertRow();
  const cell1 = row.insertCell();
  row.insertCell().textContent = breakType;
  row.insertCell();
  row.insertCell();
  row.insertCell();
  row.classList.add("break-row");
  cell1.textContent = "";
  document.getElementById("breakType").value = "";
}

// Add a regular session
function addToAgenda() {
  const subs = Array.from(subTopicSelect.selectedOptions).map(o => o.value);
  const time = document.getElementById("startTime").value;
  const dur = parseInt(document.getElementById("duration").value);
  const mode = document.getElementById("mode").value;
  const facilitator = document.getElementById("facilitator").value || "â€”";

  if (!subs.length || !time || !dur || !mode) {
    alert("Please complete all fields (except Day or Break).");
    return;
  }

  const start = toDate(time);
  const end = new Date(start.getTime() + dur * 60000);
  const timeSlot = `${formatTime(start)} â€“ ${formatTime(end)}`;

  subs.forEach(sub => {
    const row = agendaBody.insertRow();
    row.insertCell().textContent = timeSlot;
    row.insertCell().textContent = sub;
    row.insertCell().textContent = `Understand ${sub}`;
    row.insertCell().textContent = mode;
    row.insertCell().textContent = facilitator;
  });

  topicSelect.value = "";
  subTopicSelect.innerHTML = "";
  subTopicSelect.disabled = true;
  document.getElementById("startTime").value = "";
  document.getElementById("mode").value = "";
  document.getElementById("facilitator").value = "";
}

// Export Excel
function downloadExcel() {
  const data = [["Time", "Session", "Learning Objective", "Mode", "Facilitator"]];
  document.querySelectorAll("#agendaTable tbody tr").forEach(row => {
    if (row.classList.contains("day-row")) {
      data.push([row.cells[0].textContent, "", "", "", ""]);
    } else {
      const cells = Array.from(row.cells).map(cell => cell.textContent);
      data.push(cells);
    }
  });
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Agenda");
  XLSX.writeFile(wb, "Workshop_Agenda.xlsx");
}
</script>
</body>
</html>
